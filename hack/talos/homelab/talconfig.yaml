# Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

---
clusterName: ${clusterName}
talosVersion: ${talosVersion}
kubernetesVersion: ${kubernetesVersion}
endpoint: ${endpoint}
allowSchedulingOnMasters: true

additionalMachineCertSans:
- ${ip_portefaix}
# additionalApiServerCertSans:
# - home-cluster.local
clusterPodNets:
- 10.244.0.0/16
clusterSvcNets:
- 10.96.0.0/12
cniConfig:
  name: none

patches:
- "@./patch-tailscale-underlay.yaml"

nodes:
- hostname: portefaix
  controlPlane: true
  ipAddress: ${ip_portefaix}
  installDisk: /dev/sdb
  machineSpec:
    mode: metal
    arch: amd64
    # useUKI: true
    # secureboot: true
  nodeLabels:
    node-role.kubernetes.io/master: "true"
  # nodeAnnotations:
  #   rack: homelab
  # nodeTaints:
  #   mytaint: mytaints:NoSchedule
  nameservers:
  - 1.1.1.1
  - 8.8.8.8
  schematic:
    customization:
      # extraKernelArgs:
      # - net.ifnames=0
      systemExtensions:
        officialExtensions:
        - siderolabs/tailscale
  extensionServices:
  - name: tailscale
    environment:
    - TS_AUTH_KEY=${TAILSCALE_AUTHKEY}
# - hostname: portefaix-1
#   controlPlane: false
#   ipAddress: 192.1680.0.208
#   installDisk: /dev/sdb
#   nodeLabels:
#     node-role.kubernetes.io/worker: "true"
#     node-role.kubernetes.io/lowcost: "true"
# - hostname: portefaix-2
#   controlPlane: false
#   ipAddress: 192.1680.0.116
#   installDisk: /dev/sdb
#   nodeLabels:
#     node-role.kubernetes.io/worker: "true"
#     node-role.kubernetes.io/lowcost: "true"
# - hostname: portefaix-6
#   controlPlane: false
#   ipAddress: 192.1680.0.233
#   installDisk: /dev/sdb
#   nodeLabels:
#     node-role.kubernetes.io/worker: "true"
#     node-role.kubernetes.io/infra: "true"
# - hostname: portefaix-7
#   controlPlane: false
#   ipAddress: 192.1680.0.250
#   installDisk: /dev/sdb
#   nodeLabels:
#     node-role.kubernetes.io/worker: "true"
#     node-role.kubernetes.io/infra: "true"
